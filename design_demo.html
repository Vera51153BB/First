<!doctype html>
<html lang="ru" data-theme="blue">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Charts ‚Äî Mobile-first UI</title>
  <meta name="color-scheme" content="dark light" />

  <!-- SVG symbols (–µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å, –±–µ–∑ —ç–º–æ–¥–∑–∏) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
    <!-- refresh (–¥–≤–µ —Å—Ç—Ä–µ–ª–∫–∏) -->
    <symbol id="i-refresh" viewBox="0 0 24 24">
      <path fill="currentColor" d="M17.65 6.35A7.95 7.95 0 0 0 12 4a8 8 0 1 0 7.75 6h-2.1A6 6 0 1 1 12 6c1.66 0 3.14.69 4.22 1.78L14 10h6V4z"/>
    </symbol>
    <!-- gear -->
    <symbol id="i-gear" viewBox="0 0 24 24">
      <path fill="currentColor" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      <circle cx="12" cy="12" r="3" fill="currentColor"/>
    </symbol>
  </svg>

  <style>
    :root{
      --sep:#a7a093;
      --green:#79c172;
      --red:#ff5f5f;

      --hbar:40px;        /* –±–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –∑–æ–Ω */
      --hbar-min:32px;    /* —É–∂–∞—Ç–∏–µ –Ω–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
      --padX:clamp(12px, 4vw, 18px);   /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø */

      --radius:12px;
      --muted:#9bb0cc;
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --fontSize: clamp(12px, 1.8vw, 14px);
      --uiSize: clamp(28px, 5.5vw, 34px);
      --icon:  clamp(14px, 2.8vw, 18px);

            /* ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ... */
      --focus-ring: rgba(122,167,255,.75);   /* —Ü–≤–µ—Ç –∫–æ–ª—å—Ü–∞ */
      --focus-glow: rgba(122,167,255,.35);   /* –≤–Ω–µ—à–Ω–µ–µ –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
    }

    /* —Ç–µ–º—ã */
    html[data-theme="blue"]{
      --bg:#050029;
      --panel:#0a0637;
      --panel2:#070430;
      --text:#eaf0ff; /* –±—É–¥–µ—Ç –ø–æ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º */
    }
    html[data-theme="dark"]{
      --bg:#0b0e14;
      --panel:#11151c;
      --panel2:#0f1319;
      --text:#e5e7eb;
    }
    html[data-theme="light"]{
      --bg:#f7f8fc;
      --panel:#ffffff;
      --panel2:#f2f4f8;
      --text:#0d1321;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:var(--bg); color:var(--text);
      font: var(--fontSize)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow:hidden; /* –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    }

    .viewport{
      height:100svh;
      display:grid;
      grid-template-rows: var(--h) 1px 1fr 1px var(--h); /* –≤–µ—Ä—Ö, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, —Ü–µ–Ω—Ç—Ä, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –Ω–∏–∑ */
      background:var(--bg);
    }
    @media (max-height:520px){ .viewport{ --h:var(--hbar-min); } }
    @media (min-height:521px){ .viewport{ --h:var(--hbar); } }

    .divider{ background:var(--sep); }

    /* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å-–ø–æ–¥–ª–æ–∂–∫–∞ (–±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ –¢–ó) */
    .topbar{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    /* —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å ‚Äî —á–∏—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ */
    .center{ position:relative; background:var(--bg); }

    /* –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–æ—Å–Ω–æ–≤–Ω–∞—è) */
    .bottombar{
      display:flex; align-items:center; justify-content:space-between;
      padding:0 var(--padX);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-top:1px solid rgba(0,0,0,.18);
    }

    /* –ª–µ–≤–∞—è —á–∞—Å—Ç—å: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä + –Ω–∞–∑–≤–∞–Ω–∏–µ + –≤—Ä–µ–º—è (–ù–ï –∂–∏—Ä–Ω—ã–º) */
    .left{
      display:flex; align-items:center; gap:8px; min-width:0;
      white-space:nowrap;
    }
    .pair{ font-weight:600; /* –ø–æ–ª—É–∂–∏—Ä —á—É—Ç—å-—á—É—Ç—å, –Ω–æ –Ω–µ bold */ }
    .pair .tf{ font-weight:800; }        /* TF –æ—Å—Ç–∞–≤–ª—è–µ–º –∂–∏—Ä–Ω—ã–º */
    .time{
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      margin-left: clamp(6px,1.8vw,10px);
    }

    /* –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ —Å–≤–µ—á–µ–Ω–∏–µ–º –∏ –±–µ–ª—ã–º –±–ª–∏–∫–æ–º */
    .led{
      position:relative;
      width: clamp(12px, 2.8vw, 14px);
      height: clamp(12px, 2.8vw, 14px);
      border-radius:50%;
      background:var(--green);
      box-shadow: 0 0 12px rgba(121,193,114,.95), 0 0 26px rgba(121,193,114,.45);
      cursor:pointer; flex:0 0 auto;
    }
    .led::after{
      content:""; position:absolute; left:2px; top:2px;
      width:4px; height:4px; border-radius:50%;
      background:#fff; box-shadow: 0 0 4px rgba(255,255,255,.8);
    }

    /* –ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: TF + icon buttons */
    .right{ display:flex; align-items:center; gap: clamp(8px, 2vw, 12px); }

    /* –ë–ê–ó–û–í–ê–Ø –ö–ù–û–ü–ö–ê */
    .btn{
      height: var(--uiSize);
      padding: 0 clamp(10px, 2.6vw, 12px);
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      color:var(--text);
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; cursor:pointer; user-select:none;
      font-weight:800;
      outline:none;                       /* ring –ø–æ–∫–∞–∂–µ–º —á–µ—Ä–µ–∑ box-shadow */
      transition: box-shadow .15s ease, background .12s ease, transform .08s ease;
    }
    .btn:active{ transform: translateY(1px); }
    
    /* –ò–ö–û–ù–ö–ò-–ö–ù–û–ü–ö–ò (–±–µ–∑ –æ–±–≤–æ–¥–∫–∏) */
    .btn-icon{
      width: var(--uiSize);
      padding:0;
      aspect-ratio:1 / 1;
      border:none;            /* ‚Üê —É–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É —Ç–æ–ª—å–∫–æ —É –∏–∫–æ–Ω–æ–∫ */
      box-shadow:none;
    }
    
    /* HOVER –î–õ–Ø –ò–ö–û–ù–ö–ò (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª) */
    .btn-icon:hover{
      background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
    }
    
    /* –û–ë–©–ï–ï –ö–û–õ–¨–¶–û –§–û–ö–£–°–ê –î–õ–Ø –í–°–ï–• –ö–ù–û–ü–û–ö (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞/–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å) */
    .btn:focus-visible,
    .btn-icon:focus-visible{
      box-shadow:
        0 0 0 2px rgba(0,0,0,.35),   /* —Ç–æ–Ω–∫–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        0 0 0 4px var(--focus-ring), /* –æ—Å–Ω–æ–≤–Ω–æ–µ –∫–æ–ª—å—Ü–æ */
        0 0 12px 2px var(--focus-glow); /* –ª—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
    }
    
    /* (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∏–≥–ª—É—à–∞–µ–º —Ñ–æ–Ω —É –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ hover */
    .btn:hover{
      background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
    }

    /* –º–æ–¥–∞–ª–∫–∏ */
    .backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:20; padding:12px;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(680px,96vw);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:14px 14px 16px;
      box-shadow: var(--shadow);
    }
    .modal h3{ margin:2px 0 10px; font-size:clamp(14px,2.6vw,16px); }
    .grid-3{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px; }
    .grid-2{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; }

    .pill{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:12px; padding:10px 12px; text-align:center; cursor:pointer; font-weight:800;
    }
    .pill.active{ border-color: #7aa7ff; box-shadow: inset 0 0 0 1px rgba(122,167,255,.35); }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0; }
    .label{ color:var(--muted); }

    .close{ margin-top:12px; width:100%; }

    /* –ª–µ–≥–µ–Ω–¥–∞ */
    .legend ul{ margin:8px 0 0; padding:0 0 0 16px; }
    .legend li{ margin:6px 0; }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .dot.ok{ background:var(--green); box-shadow:0 0 10px rgba(121,193,114,.9); }
    .dot.warn{ background:#ffcc66; box-shadow:0 0 10px rgba(255,204,102,.9); }
    .dot.bad{ background:#ff5f5f; box-shadow:0 0 10px rgba(255,95,95,.9); }
  </style>
</head>
<body>
  <div class="viewport">
    <!-- –≤–µ—Ä—Ö–Ω—è—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∑–æ–Ω–∞ 40px (–ø—É—Å—Ç–∞—è, –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π; –ø–æ –¢–ó –æ—Å—Ç–∞–≤–ª—è–µ–º) -->
    <div class="topbar">
      <div class="right">
        <button class="btn" id="btnTF"><b>TF</b></button>
        <button class="btn btn-icon" id="btnRefresh" title="–û–±–Ω–æ–≤–∏—Ç—å">
          <svg><use href="#i-refresh"></use></svg>
        </button>
        <button class="btn btn-icon" id="btnSettings" title="Settings">
          <svg><use href="#i-gear"></use></svg>
        </button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: —á–∏—Å—Ç–∞—è (–ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫) -->
    <div class="center" id="chartRoot"></div>

    <div class="divider"></div>

    <!-- –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="bottombar">
      <div class="left">
        <span class="led" id="led" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã"></span>
        <span class="pair" id="pair">OKX ¬∑ BTC-USDT-SWAP ¬∑ <span class="tf">1h</span></span>
        <span class="time" id="time">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="backdrop" id="dlgSettings" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

      <div class="row">
        <div class="label">–¢–µ–º–∞</div>
        <div class="grid-3" id="themeGrid">
          <div class="pill" data-theme="light">Light</div>
          <div class="pill active" data-theme="blue">Blue</div>
          <div class="pill" data-theme="dark">Dark</div>
        </div>
      </div>

      <div class="row">
        <div class="label">–í—Ä–µ–º—è</div>
        <div class="grid-2">
          <div class="pill" data-timezone="local">–õ–æ–∫–∞–ª—å</div>
          <div class="pill active" data-timezone="utc">UTC</div>
        </div>
      </div>

      <div class="row">
        <div class="label">–§–æ—Ä–º–∞—Ç</div>
        <div class="grid-2">
          <div class="pill active" data-tfmt="clock">–¢–æ–ª—å–∫–æ –≤—Ä–µ–º—è</div>
          <div class="pill" data-tfmt="rel">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ</div>
        </div>
      </div>

      <button class="btn close" id="btnCloseSettings">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- TF -->
  <div class="backdrop" id="dlgTF" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="TF">
      <h3>–¢–∞–π–º—Ñ—Ä–µ–π–º</h3>
      <div class="grid-3" id="tfGrid">
        <div class="pill" data-tf="15m">15m</div>
        <div class="pill" data-tf="1h">1h</div>
        <div class="pill active" data-tf="4h">4h</div>
        <div class="pill" data-tf="8h">8h</div>
        <div class="pill" data-tf="12h">12h</div>
        <div class="pill" data-tf="1d">1d</div>
      </div>
      <button class="btn close" id="btnCloseTF">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- Legend -->
  <div class="backdrop" id="dlgLegend" aria-hidden="true">
    <div class="modal legend" role="dialog" aria-modal="true" aria-label="Legend">
      <h3>–ß—Ç–æ –∑–Ω–∞—á–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è?</h3>
      <ul>
        <li><span class="dot ok"></span><b>–û–Ω–ª–∞–π–Ω (WS)</b> ‚Äî –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</li>
        <li><span class="dot warn"></span><b>–î–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω (REST)</b> ‚Äî WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è.</li>
        <li><span class="dot bad"></span><b>–û—Ñ—Ñ–ª–∞–π–Ω (DIS)</b> ‚Äî –Ω–µ—Ç —Å–≤—è–∑–∏ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.</li>
      </ul>
      <button class="btn close" id="btnCloseLegend">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script>
    // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–µ–º–æ)
    const state = {
      theme: 'blue',
      tf: '1h',
      timezone: 'utc',     // 'local' | 'utc'
      tfmt: 'clock',       // 'clock' | 'rel'
      lastUpdate: Date.now(),
      pair: 'OKX ¬∑ BTC-USDT-SWAP'
    };

    // --- helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const pad2 = n => String(n).padStart(2,'0');

    function fmtClock(ts, tz){
      const d = new Date(ts);
      if (tz==='utc') return `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())} UTC`;
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    function fmtRel(ts){
      const diff = Math.max(0, Math.floor((Date.now()-ts)/1000));
      if (diff >= 3600) return 'üïê > 1h';
      const mm = Math.floor(diff/60), ss = diff%60;
      return `${pad2(mm)}:${pad2(ss)}`;
    }

    // –∞–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞–Ω–µ–ª–∏
    function applyAutoContrast(){
      const cs = getComputedStyle(document.documentElement);
      const bg = cs.getPropertyValue('--panel').trim() || '#000';
      const rgb = bg.startsWith('#') ? hex2rgb(bg) : parseRGB(bg);
      const L = luminance(rgb);
      const text = L > 0.5 ? '#0d1321' : '#e5e7eb';
      const muted = L > 0.5 ? '#4a5568' : '#9bb0cc';
      document.documentElement.style.setProperty('--text', text);
      document.documentElement.style.setProperty('--muted', muted);
    }
    function hex2rgb(hex){
      const h = hex.replace('#','');
      const n = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
      return { r:parseInt(n.slice(0,2),16), g:parseInt(n.slice(2,4),16), b:parseInt(n.slice(4,6),16) };
    }
    function parseRGB(s){ const m = s.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); return m?{r:+m[1],g:+m[2],b:+m[3]}:{r:0,g:0,b:0}; }
    function luminance({r,g,b}){ const a=[r,g,b].map(v=>{v/=255;return v<=.03928?v/12.92:Math.pow((v+.055)/1.055,2.4)}); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; }

    // --- —Ä–µ–Ω–¥–µ—Ä
    function renderBars(){
      $('#pair').innerHTML = `${state.pair} ¬∑ <span class="tf">${state.tf}</span>`;
    }
    function renderTime(){
      $('#time').textContent = (state.tfmt==='rel') ? fmtRel(state.lastUpdate) : fmtClock(state.lastUpdate, state.timezone);
    }
    function setTheme(t){
      state.theme = t;
      document.documentElement.setAttribute('data-theme', t);
      applyAutoContrast();
    }

    // --- –º–æ–¥–∞–ª–∫–∏
    function show(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    const dlgSettings = $('#dlgSettings');
    const dlgTF = $('#dlgTF');
    const dlgLegend = $('#dlgLegend');

    // settings
    $('#btnSettings').addEventListener('click', ()=>show(dlgSettings));
    $('#btnCloseSettings').addEventListener('click', ()=>hide(dlgSettings));
    dlgSettings.addEventListener('click', (e)=>{ if(e.target===dlgSettings) hide(dlgSettings); });

    $('#themeGrid').addEventListener('click', (e)=>{
      const p = e.target.closest('.pill[data-theme]'); if(!p) return;
      $$('#themeGrid .pill').forEach(x=>x.classList.toggle('active', x===p));
      setTheme(p.dataset.theme);
    });

    $$('#dlgSettings [data-timezone]').forEach(p=>p.addEventListener('click', ()=>{
      $$('#dlgSettings [data-timezone]').forEach(x=>x.classList.remove('active'));
      p.classList.add('active'); state.timezone = p.dataset.timezone; renderTime();
    }));
    $$('#dlgSettings [data-tfmt]').forEach(p=>p.addEventListener('click', ()=>{
      $$('#dlgSettings [data-tfmt]').forEach(x=>x.classList.remove('active'));
      p.classList.add('active'); state.tfmt = p.dataset.tfmt; renderTime();
    }));

    // TF
    $('#btnTF').addEventListener('click', ()=>show(dlgTF));
    $('#btnCloseTF').addEventListener('click', ()=>hide(dlgTF));
    dlgTF.addEventListener('click', (e)=>{ if(e.target===dlgTF) hide(dlgTF); });
    $('#tfGrid').addEventListener('click', (e)=>{
      const p = e.target.closest('.pill[data-tf]'); if(!p) return;
      $$('#tfGrid .pill').forEach(x=>x.classList.toggle('active', x===p));
      state.tf = p.dataset.tf; renderBars(); hide(dlgTF);
    });

    // legend by indicator click
    $('#led').addEventListener('click', ()=>show(dlgLegend));
    $('#btnCloseLegend').addEventListener('click', ()=>hide(dlgLegend));
    dlgLegend.addEventListener('click', (e)=>{ if(e.target===dlgLegend) hide(dlgLegend); });

    // refresh (–¥–µ–º–æ ‚Äî —Ç–æ–ª—å–∫–æ ¬´–æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è¬ª)
    function doRefresh(){ state.lastUpdate = Date.now(); renderTime(); }
    $('#btnRefresh').addEventListener('click', doRefresh);

    // —Ç–∏–∫ –≤—Ä–µ–º–µ–Ω–∏
    setInterval(renderTime, 1000);

    // —Å—Ç–∞—Ä—Ç
    setTheme('blue');     // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–∏–Ω—è—è
    state.lastUpdate = Date.now();
    renderBars(); renderTime();

    // ESC –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ [dlgSettings, dlgTF, dlgLegend].forEach(hide); }
    });
  </script>
</body>
</html>
