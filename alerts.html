<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Уведомления</title>
<style>
  :root{
    --bg:#050029;
    --text:#e6ddcd;
    --green:#79c172;
    --red:#ff5f5f;
    --muted:#a7a093;

    --card-r: 20px;                  /* радиус и для блоков, и для кнопки */
    --v-gap: clamp(14px,3.5vw,22px); /* ЕДИНЫЙ вертикальный шаг «воздуха» */

    --pill-h: clamp(40px,9vw,56px);
    --pill-w: clamp(180px,60vw,320px);
    --radius: 999px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    line-height:1.35;
    display:flex; justify-content:center;
  }

  .wrap{
    width:min(680px,92vw);
    padding:clamp(16px,3vw,28px);
    display:flex; flex-direction:column;
  }
  h1{
    margin:0 0 .8rem;font-weight:800;letter-spacing:.02em;
    font-size:clamp(21px,5vw,29px); text-transform:uppercase;
  }
  
  /* Вертикальная колонка: ВСЕ — список — кнопка — подпись */
  .stack{
    display:flex; flex-direction:column;
    gap: var(--v-gap);
    padding-bottom: var(--v-gap); /* воздух до низа страницы */
  }

  /* Карточки */
  .section{
    padding:clamp(12px,2.6vw,18px);
    border:1px solid #2a2458;
    border-radius:var(--card-r);
    background:rgba(255,255,255,.02);
  }

  .title{ font-size:clamp(16px,3.6vw,22px); font-weight:700 }

  /* Шапка секции «все» */
  .controls-header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:clamp(10px,2.5vw,14px);
  }
  .status-badge{
    display:inline-block; padding:.25em .8em; border-radius:999px;
    font-size:clamp(12px,2.8vw,14px); font-weight:700;
    background:#211a53; color:var(--text); border:1px solid #3a3276;
  }

  /* Две большие кнопки «включить/выключить» */
  .actions{ display:flex; gap:clamp(10px,2.6vw,14px) }
  .btn{
    border:none; cursor:pointer; border-radius:999px;
    padding: clamp(10px,2.6vw,14px) clamp(18px,4.4vw,26px);
    font-size:clamp(14px,3.6vw,18px); font-weight:800; letter-spacing:.02em;
    color:#050029; transition:transform .08s ease, filter .2s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
    flex: 1 1 0;        /* одинаковая ширина */
    white-space: nowrap;/* остаются в одну строку на мобилках */

    /* эффекты: риппл */
    position: relative;
    overflow: hidden;
  }
  .btn.green{ background:var(--green) }
  .btn.red  { background:var(--red) }
  .btn:active{ transform:translateY(1px) scale(.985); filter:brightness(.98) }
  .btn:focus-visible{ outline:2px solid #8aa3ff; outline-offset:2px }

  /* Риппл у .btn и .save-btn */
  .btn::after, .save-btn::after{
    content:"";
    position:absolute;
    left: var(--rx,50%); top: var(--ry,50%);
    width:0; height:0; border-radius:50%;
    background: rgba(255,255,255,.35);
    transform: translate(-50%,-50%);
    opacity:0; pointer-events:none;
  }
  .rippling::after{ animation: btn-ripple .5s ease-out; }
  @keyframes btn-ripple{
    0%   { width:0; height:0; opacity:.35; }
    80%  { width:360px; height:360px; opacity:.12; }
    100% { width:420px; height:420px; opacity:0; }
  }

  /* Список уведомлений */
  .item{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:12px 0 }
  .item + .item{ border-top:1px dashed #2a2458 }
  .name{ font-size:clamp(15px,3.2vw,20px) }
  .state{ color:var(--muted); font-size:clamp(12px,2.8vw,14px); margin-top:6px }

  /* Переключатель */
  .switch{
    --pad:6px;
    position:relative; width:var(--pill-w); height:var(--pill-h);
    border-radius:var(--radius); border:1px solid #382f78;
    background:linear-gradient(90deg, var(--green) 0 50%, var(--red) 50% 100%);
    display:inline-flex; align-items:center; justify-content:space-between;
    padding:0 var(--pad); color:#050029; user-select:none; cursor:pointer;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 18px rgba(0,0,0,.25);
  }
  .switch .label{
    font-weight:900; letter-spacing:.03em; text-transform:uppercase;
    font-size:clamp(12px,2.8vw,16px); width:50%;
    display:flex; align-items:center; justify-content:center;
    opacity:.65; transition:opacity .18s;
  }
  .switch[data-on="true"]  .label:first-child{ opacity:1; }
  .switch[data-on="false"] .label:last-child { opacity:1; }

  .switch .knob{
    position:absolute; top:50%; transform:translateY(-50%);
    width: calc(var(--pill-h) - var(--pad)*2); height: calc(var(--pill-h) - var(--pad)*2);
    border-radius:50%; background:#2d2a59;
    box-shadow: 0 6px 12px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    transition: left .22s cubic-bezier(.2,.9,.2,1.2), box-shadow .2s;
    left: var(--pad); /* «вкл» слева */
  }
  .switch[data-on="false"] .knob{ left: calc(100% - var(--pill-h) + var(--pad)) }
  .switch[data-on="true"]  .knob{ box-shadow: 0 8px 16px rgba(0,0,0,.42), inset 0 0 0 1px rgba(255,255,255,.08); }

  /* Мягкая подсветка активной половины */
  .switch::before{
    content:"";
    position:absolute; inset:2px; border-radius:var(--radius);
    background:
      linear-gradient(90deg,
        rgba(121,193,114,.25) 0 50%,
        rgba(255,95,95,.25) 50% 100%);
    mix-blend-mode: screen;
    opacity:.25; transition:opacity .22s;
  }

  /* Клавиатурный фокус */
  .switch:focus-visible{ outline:2px solid #8aa3ff; outline-offset:3px }

  /* Кнопка «Сохранить настройки» */
  .save-btn{
    width:100%;
    border-radius: var(--card-r);
    border: 1px solid var(--text);
    background: var(--bg);
    color: var(--text);
    padding: clamp(14px,3.5vw,18px);
    font-weight:800; letter-spacing:.02em;
    font-size: clamp(16px,4vw,22px);
    text-align:center;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
    cursor:pointer;
    transition: transform .08s ease, filter .2s ease;
    position:relative; overflow:hidden;       /* для риппла */
  }
  .save-btn:active{ transform: translateY(1px) scale(.99) }
  .save-btn:focus-visible{ outline:2px solid #8aa3ff; outline-offset:3px }

  /* «Успешно сохранено» — вспышка */
  .save-btn.saved{ animation: saved-flash 650ms ease-out; }
  @keyframes saved-flash{
    0%   { box-shadow: 0 0 0 0 rgba(121,193,114,.0), 0 6px 18px rgba(0,0,0,.25); }
    40%  { box-shadow: 0 0 0 10px rgba(121,193,114,.25), 0 10px 22px rgba(0,0,0,.3); }
    100% { box-shadow: 0 0 0 0 rgba(121,193,114,.0), 0 6px 18px rgba(0,0,0,.25); }
  }
  .btn.is-busy, .save-btn.is-busy{ pointer-events:none; opacity:.7; filter:grayscale(.15); }

  /* Подпись в самом низу */
  .footnote{ color:var(--muted); text-align:center; font-size:clamp(12px,2.8vw,14px) }
  
  /* быстрый тост для браузера */
  .toast{
    position: fixed;
    left: 50%;
    bottom: 24px;
    transform: translateX(-50%);
    background: #1b1645;
    color: #e6ddcd;
    border: 1px solid #3a3276;
    border-radius: 12px;
    padding: 12px 16px;
    opacity: 0;
    transition: opacity .2s;
    z-index: 9999;
  }
  .toast.show{ opacity: 1; }
 
  /* ----- Мобильная раскладка ----- */
  @media (max-width: 786px) {
    .item{
      grid-template-columns: 1fr;
      align-items: start;
      gap: 6px;
    }
    .item .switch{ justify-self: end; margin-top: 4px; }
    .item .name{ margin-bottom: 2px; }
  }
</style>
</head>
<body>
  <main class="wrap">
    <h1>Управление уведомлениями</h1>
    <div class="stack">

      <!-- Секция «все» -->
      <section class="section">
        <div class="controls-header">
          <div class="title">все</div>
          <span id="allState" class="status-badge">частично</span>
        </div>
        <div class="actions">
          <button class="btn green" id="btnAllOn">включить</button>
          <button class="btn red"   id="btnAllOff">выключить</button>
        </div>
      </section>

      <!-- Список тумблеров -->
      <section class="section" id="list"></section>

      <!-- Кнопка сохранения -->
      <button class="save-btn" id="saveBtn">Сохранить настройки</button>

      <!-- Подпись внизу страницы -->
      <div class="footnote">
        Переключатели сохраняются на этом устройстве и применяются мгновенно.
      </div>
    </div>
  </main>

<script>
/* ===== модель ===== */
const STORAGE_KEY = 'okx_alerts_v1';
const DEFAULT_ALERTS = [
  { id: 'balance', name: 'Баланс монет', on: true },
  { id: 'alert2',  name: 'Индекс RSI', on: true },
  { id: 'alert3',  name: 'уведомление 3', on: true },
  { id: 'alert4',  name: 'уведомление 4', on: true },
];

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return DEFAULT_ALERTS.slice();
    const arr = JSON.parse(raw);
    const map = Object.fromEntries(arr.map(a=>[a.id, a.on]));
    return DEFAULT_ALERTS.map(d => ({...d, on: map[d.id] ?? d.on}));
  }catch{ return DEFAULT_ALERTS.slice(); }
}
function saveState(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

/* ===== рендер ===== */
const listEl = document.getElementById('list');
const allStateEl = document.getElementById('allState');
let alerts = loadState();

function render(){
  listEl.innerHTML = '';
  alerts.forEach(a=>{
    const row = document.createElement('div');
    row.className = 'item';

    const left = document.createElement('div');
    left.innerHTML = `
      <div class="name">${a.name}</div>
      <div class="state" id="state-${a.id}">${a.on ? 'включено' : 'выключено'}</div>
    `;
    row.appendChild(left);

    const sw = document.createElement('button');
    sw.type = 'button';
    sw.className = 'switch';
    sw.setAttribute('data-on', String(a.on));
    sw.setAttribute('aria-pressed', String(a.on));
    sw.innerHTML = `
      <span class="label">ВКЛ</span>
      <span class="label">ВЫК</span>
      <span class="knob"></span>
    `;

    sw.addEventListener('click', ()=>{
      a.on = !a.on;
      saveState(alerts);
      updateOne(a.id);
      updateAllBadge();
      onToggleChanged(a.id);

      // лёгкий хаптик при переключении (если внутри Telegram)
      try{ tg?.HapticFeedback?.selectionChanged(); }catch{}
    });

    row.appendChild(sw);
    listEl.appendChild(row);
  });

  updateAllBadge();
}

function updateOne(id){
  const a = alerts.find(x=>x.id===id);
  const state = document.getElementById('state-'+id);
  if(state) state.textContent = a.on ? 'включено' : 'выключено';
  const idx = alerts.findIndex(x=>x.id===id);
  const btn = listEl.querySelectorAll('.switch')[idx];
  if(btn){
    btn.setAttribute('data-on', String(a.on));
    btn.setAttribute('aria-pressed', String(a.on));
  }
}

function updateAllBadge(){
  const onCount = alerts.filter(a=>a.on).length;
  let txt = 'частично';
  if(onCount===0) txt='выключено';
  else if(onCount===alerts.length) txt='включено';
  allStateEl.textContent = txt;
}

/* Кнопки «все» */
document.getElementById('btnAllOn').addEventListener('click', ()=>{
  alerts.forEach(a=>a.on=true); saveState(alerts); render();
});
document.getElementById('btnAllOff').addEventListener('click', ()=>{
  alerts.forEach(a=>a.on=false); saveState(alerts); render();
});

/* ===== Telegram Web App (поп-ап + закрытие после OK; без падений на Desktop) ===== */
/* ===== Telegram Web App (Desktop-safe) ===== */
const DEBUG = true;
const SEND_ON_TOGGLE = false; // шлём только по «Сохранить»

const tg = window.Telegram?.WebApp ?? null;
try { tg?.ready(); tg?.expand(); } catch {}

const PLATFORM = tg?.platform || '';
const IS_DESKTOP = PLATFORM === 'tdesktop' || PLATFORM === 'macos';

/* тост на странице — для Desktop/браузера */
function showToast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{ el.classList.remove('show'); el.remove(); }, 2600);
}

/* безопасная отправка в бота */
function safeSendData(payload){
  try {
    if (typeof tg?.sendData === 'function') {
      tg.sendData(payload);
      if (DEBUG) console.log('[WebApp] sendData →', payload);
      return true;
    }
  } catch(e){ console.error('[WebApp] sendData error:', e); }
  if (DEBUG) console.warn('[WebApp] not in Telegram (sendData unavailable)');
  return false;
}

/* СВОДКА статусов в нужном виде */
function buildSummary(list){
  // удобная мапа id→on
  const on = Object.fromEntries(list.map(a => [a.id, !!a.on]));

  const order = [
    ['balance', 'Баланс монет'],
    ['alert2',  'Индекс RSI'],
    ['alert3',  'Уведомление 3'],
    ['alert4',  'Уведомление 4'],
  ];

  const values = order.map(([id]) => on[id]);
  let body;

  if (values.every(Boolean)) {
    body = 'Все уведомления: ВКЛЮЧЕНЫ';
  } else if (values.every(v => !v)) {
    body = 'Все уведомления: ВЫКЛЮЧЕНЫ';
  } else {
    body = order
      .map(([id, title]) => `${title} — ${on[id] ? 'ВКЛЮЧЁН' : 'ВЫКЛЮЧЕН'}`)
      .join('\n');
  }

  // Итоговое сообщение для окна/алерта/тоста
  return [
    'OKXcandlebot',
    'Новые настройки уведомлений:',
    '',
    body,
    '',
    'Настройки сохранены на этом устройстве.'
  ].join('\n');
}

/* (опционально) лог на переключателях */
function onToggleChanged(alertId){
  if (DEBUG) console.log('[WebApp] toggle changed:', alertId, alerts);
  if (SEND_ON_TOGGLE) {
    clearTimeout(window.__sendTimer);
    window.__sendTimer = setTimeout(()=>{
      const payload = JSON.stringify({ type:'toggle', alerts });
      const sent = safeSendData(payload);
      if (!sent) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(alerts)); } catch {} }
    }, 250);
  }
}

/* поп-ап/алерт/тост с закрытием ТОЛЬКО на мобильных */
function notifySavedAndMaybeClose(){
  const message = buildSummary(alerts);

  // Desktop: избегаем showPopup/showAlert — у некоторых сборок TDesktop это закрывает клиент
  if (IS_DESKTOP) {
    showToast(message);
    return;
  }

  // Мобильные: полноценный поп-ап Telegram + закрытие после OK
  if (typeof tg?.showPopup === 'function') {
    try {
      tg.showPopup(
        { title: 'OKXcandlebot', message, buttons: [{ id:'ok', type:'ok' }] },
        (btnId) => { if (btnId === 'ok') setTimeout(()=>{ try { tg.close(); } catch {} }, 120); }
      );
      return;
    } catch(e){ console.warn('showPopup failed, fallback to showAlert', e); }
  }

  if (typeof tg?.showAlert === 'function') {
    try {
      tg.showAlert(message, () => setTimeout(()=>{ try { tg.close(); } catch {} }, 120));
      return;
    } catch(e){ console.warn('showAlert failed, fallback to toast', e); }
  }

  showToast(message);
}

/* Риппл + лёгкий хаптик на кликах по кнопкам */
function attachRipple(selector){
  document.querySelectorAll(selector).forEach(el=>{
    el.addEventListener('click', (e)=>{
      const rect = el.getBoundingClientRect();
      el.style.setProperty('--rx', (e.clientX - rect.left) + 'px');
      el.style.setProperty('--ry', (e.clientY - rect.top)  + 'px');
      el.classList.remove('rippling'); void el.offsetWidth; el.classList.add('rippling');
      try{ tg?.HapticFeedback?.impactOccurred('light'); }catch{}
    });
  });
}

/* «Сохранить настройки» — отправка, вспышка, сводка */
const saveEl = document.getElementById('saveBtn');
saveEl.addEventListener('click', ()=>{
  const payload = JSON.stringify({ type:'save', alerts });
  const sent = safeSendData(payload);
  if (!sent) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(alerts)); } catch {} }

  // визуальный отклик
  saveEl.classList.remove('saved'); void saveEl.offsetWidth; saveEl.classList.add('saved');
  try{ tg?.HapticFeedback?.notificationOccurred('success'); }catch{}

  notifySavedAndMaybeClose();
});

/* init для эффектов */
attachRipple('.btn, .save-btn');

/* диагностика */
tg?.onEvent?.('web_app_close', () => { if (DEBUG) console.log('[WebApp] event: web_app_close');
});

/* init */
render();
attachRipple('.btn, .save-btn');

/* диагностический лог закрытия, если клиент сам решит закрыть WebApp */
tg?.onEvent?.('web_app_close', () => {
  if (DEBUG) console.log('[WebApp] event: web_app_close');
});
</script>
</body>
</html>
