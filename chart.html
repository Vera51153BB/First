<!doctype html>
<html lang="ru" data-theme="blue">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Charts — Mobile-first UI</title>
  <meta name="color-scheme" content="dark light" />
  <!-- prefs.js должен грузиться ПЕРВЫМ, чтобы saveUserPref был доступен далее -->
  <script src="../assets/js/prefs.js?v=1" defer></script>
  <!-- основной код страницы (вынесен из инлайна) -->
  <script src="../assets/js/chart.page.js?v=1" defer></script>
  
  <style>
    :root{
      --sep:#a7a093;
      --green:#79c172;
      --red:#ff5f5f;

      --hbar:46px;        /* базовая высота зон */
      --hbar-min:32px;    /* ужатие на экстремально низких экранах */
      --padX:clamp(12px, 4vw, 18px);   /* адаптивный горизонтальный отступ */

      --radius:12px;
      --muted:#9bb0cc;
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --fontSize: clamp(12px, 1.8vw, 14px);
      --uiSize: clamp(28px, 5.5vw, 34px);
      --icon:  clamp(14px, 2.8vw, 18px);

            /* ... существующие переменные ... */
      --focus-ring: rgba(122,167,255,.75);   /* цвет кольца */
      --focus-glow: rgba(122,167,255,.35);   /* внешнее мягкое свечение */

      /* ИНДИКАТОРЫ */
      --led-ok:#5fe281;      /* зелёный индикатора */
      --led-warn:#ffc857;    /* жёлтый индикатора */
      --led-bad:#ff5f5f;     /* красный индикатора */

      /* ——— Индикаторы в легенде: «сферические» точки с лёгким дыханием ——— */
      /* палитра сфер */
      --ok-mid:#3BD16A;   --ok-deep:#1E7E46;   --ok-glow:rgba(59,209,106,.42);
      --warn-mid:#FFCC66; --warn-deep:#CC8A00; --warn-glow:rgba(255,204,102,.40);
      --bad-mid:#FF5F5F;  --bad-deep:#B80D1A;  --bad-glow:rgba(255,95,95,.42);
    
      /* дыхание: длительность и амплитуда (можно подкрутить) */
      --breathe-dur: 1400ms;
      --breathe-min: .92;
      --breathe-max: 1.12;
    }
    
    @media (max-width: 768px){
      :root{
        --uiSize: clamp(32px, 7vw, 36px);
        --icon:  clamp(22px, 4vw, 26px);
      }
    }
    
    /* темы */
    html[data-theme="blue"]{
      --bg:#050029;
      --panel:#0a0637;
      --panel2:#070430;
      --text:#eaf0ff; /* будет подправлено автоконтрастом */
    }
    html[data-theme="dark"]{
      --bg:#0b0e14;
      --panel:#11151c;
      --panel2:#0f1319;
      --text:#e5e7eb;
    }
    html[data-theme="light"]{
      --bg:#f7f8fc;
      --panel:#ffffff;
      --panel2:#f2f4f8;
      --text:#0d1321;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:var(--bg); color:var(--text);
      font: var(--fontSize)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow:hidden; /* без прокрутки */
    }

    .viewport{
      height:100svh;
      display:grid;
      grid-template-rows: var(--h) 1px 1fr 1px var(--h); /* верх, разделитель, центр, разделитель, низ */
      background:var(--bg);
    }
    
    @media (max-height:768px){ .viewport{ --h:var(--hbar-min); } }
    @media (min-height:769px){ .viewport{ --h:var(--hbar); } }

    /* разделитель — единственный «бордер» между центром и баром */
    .divider{
      height:1px;
      background:var(--sep);
      position:relative;
      z-index:2;              /* поверх соседей */
    }

    /* верхняя панель-подложка (без контента по ТЗ) */
    .topbar{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    /* центральная область — чистое поле для реального графика */
    .center{ position:relative; background:var(--bg); }

    /* нижняя панель — постоянный резерв 12px справа */
    .bottombar{
      height: var(--h);
      display:flex; align-items:center;
      padding-left: var(--padX);
      padding-right: 12px;       /* резерв за кнопкой */
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-top:1px solid rgba(0,0,0,.18);
      gap:8px;
    }
    
    /* левая группа — тянется, но без растягивания пары */
    .left{
      display:flex; align-items:center; gap:8px;
      min-width:0; white-space:nowrap;
      flex:1 1 auto;            /* группа занимает доступную ширину */
      overflow: visible;        /* было hidden — нужно visible, чтобы не резать свечение индикатора */
    }
    
    /* ПАРА — больше НЕ растёт, только сжимается при нехватке места */
    .pair{
      display:block;
      flex:0 1 auto;            /* <-- было 1 1 auto; теперь 0 1 auto */
      min-width:0;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-weight:600;
    }
    .pair .tf{ font-weight:inherit; } /* 1h не жирный */
    
    /* время — фиксированное, не сжимать */
    .time{
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      margin-left:8px;
      flex:0 0 auto;
    }
    
    /* Обновить — всегда видима, не сжимать, небольшой зазор слева */
    #btnRefresh{
      margin-left:8px;
      flex:0 0 var(--uiSize);
    }

    /* индикатор со свечением и белым бликом */
    /* универсальный «шар» — 1 элемент */
    .led{
      --led-size: clamp(12px, 2.8vw, 14px);
      --led-color: var(--led-ok);         /* по умолчанию ОК */
      position: relative;
      width: var(--led-size);
      height: var(--led-size);
      border-radius: 50%;
      flex: 0 0 auto;
      /* тело шара + мягкая периферия через радиальные градиенты */
      background:
        radial-gradient(45% 45% at 30% 28%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%) /* внутренний бликовый градиент */,
        radial-gradient(100% 100% at 50% 50%, var(--led-color), color-mix(in srgb, var(--led-color) 65%, #000) );
      /* внешнее свечение — лёгкое «дыхание» */
      box-shadow:
        0 0 10px color-mix(in srgb, var(--led-color) 75%, transparent),
        0 0 22px color-mix(in srgb, var(--led-color) 45%, transparent);
      animation: none; /* анимация отключена, свечение остаётся. animation: led-breathe 2.8s ease-in-out infinite; */
      cursor: pointer;
    }
    
    /* белый «блик» — маленький и без обводки */
    .led::after{
      content:"";
      position:absolute;
      left:18%; top:16%;
      width:28%; height:28%;
      border-radius:50%;
      background:#fff;
      box-shadow:0 0 3px rgba(255,255,255,.6);
    }
    
    /* состояния через дата-атрибут */
    .led[data-state="ok"]   { --led-color: var(--led-ok); }
    .led[data-state="warn"] { --led-color: var(--led-warn); }
    .led[data-state="bad"]  { --led-color: var(--led-bad); }
    
    /*  мягкое «дыхание» свечения 
    @keyframes led-breathe{
      0%,100%{ box-shadow:
        0 0 8px  color-mix(in srgb, var(--led-color) 65%, transparent),
        0 0 18px color-mix(in srgb, var(--led-color) 35%, transparent); }
      50%{ box-shadow:
        0 0 12px color-mix(in srgb, var(--led-color) 80%, transparent),
        0 0 26px color-mix(in srgb, var(--led-color) 50%, transparent); }
    } */
    
    /* правая часть: TF + icon buttons */
    .right{ display:flex; align-items:center; gap: clamp(8px, 2vw, 12px); }

    /* БАЗОВАЯ КНОПКА */
    .btn{
      height: var(--uiSize);
      padding: 0 clamp(10px, 2.6vw, 12px);
      border: none;
      border-radius: var(--radius);                     /* ← добавили */
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      font-weight: 800;
      outline: none;                                    /* ring рисуем тенью */
      -webkit-tap-highlight-color: transparent;         /* мобильный тап */
      transition: box-shadow .15s ease, background .12s ease, transform .08s ease;
    }
    .btn:active{ transform: translateY(1px); }
    
    /* ИКОНКИ-КНОПКИ (иконки без рамки, квадратная плашка) */
    .btn-icon{
      width: var(--uiSize);
      padding: 0;
      aspect-ratio: 1 / 1;
      /* border:none;         ← уже задано в .btn, можно не дублировать */
      /* box-shadow:none;     ← не обязателен */
    }
    
    /* размер встроенных SVG-иконок и наследование цвета темы */
    .btn-icon svg{
      width: var(--icon);
      height: var(--icon);
      display: block;
      fill: currentColor;                                /* на всякий случай */
    }
    
    /* HOVER для иконок */
    .btn-icon:hover{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.04));
    }
    
    /* ОБЩЕЕ КОЛЬЦО ФОКУСА (клавиатурная доступность) */
    .btn:focus-visible{
      box-shadow:
        0 0 0 2px rgba(0,0,0,.35),        /* подложка для контраста */
        0 0 0 4px var(--focus-ring),      /* кольцо */
        0 0 12px 2px var(--focus-glow);   /* мягкое свечение */
    }
    
    /* необязательный hover для всех кнопок-пиллов (в т.ч. TF) */
    .btn:hover{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.04));
    }
    
    /* Disabled-состояние (если используешь) */
    .btn:disabled{
      opacity: .5;
      cursor: default;
      pointer-events: none;
    }

    /* модалки */
    .backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:20; padding:12px;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(680px,96vw);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:14px 14px 16px;
      box-shadow: var(--shadow);
    }
    .modal h3{ margin:2px 0 10px; font-size:clamp(14px,2.6vw,16px); }
    .grid-3{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px; }
    .grid-2{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; }

    .pill{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:12px; padding:10px 12px; text-align:center; cursor:pointer; font-weight:800;
    }
    .pill.active{ border-color: #7aa7ff; box-shadow: inset 0 0 0 1px rgba(122,167,255,.35); }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0; }
    .label{ color:var(--muted); }

    .close{ margin-top:12px; width:100%; }

    /* легенда */
    .legend ul{
      /* убираем стандартные маркеры */
      list-style: none;
      margin: 8px 0 0;
      padding: 0;
    }
    .legend li{
      /* аккуратное выравнивание точки и текста в ряд */
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    /* базовая точка */
    .legend .dot{
      position:relative;
      width:14px; height:14px; border-radius:50%;
      flex:0 0 auto;
    }
    
    /* сама «сфера» (рад градиент + лёгкий блик) */
    .legend .dot::before{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background:
        radial-gradient(circle at 34% 30%, rgba(255,255,255,.95) 0 18%, transparent 19%) /* блик */,
        radial-gradient(circle at 50% 55%, var(--_mid) 0 70%, var(--_deep) 76% 100%);    /* тело */
      box-shadow: 0 0 8px var(--_glow);
    }
    
    /* внешний ореол — ТОЛЬКО он анимируется */
    .legend .dot::after{
      content:""; position:absolute; inset:-8px; border-radius:inherit;
      background: radial-gradient(circle, var(--_glow), transparent 60%);
      opacity:.55; pointer-events:none;
      transform: scale(var(--breathe-min));
      animation: breathe var(--breathe-dur) ease-in-out infinite;
      will-change: transform, opacity;
    }
    
    /* подстановка цветов для состояний */
    .legend .dot.ok   { --_mid:var(--ok-mid);   --_deep:var(--ok-deep);   --_glow:var(--ok-glow); }
    .legend .dot.warn { --_mid:var(--warn-mid); --_deep:var(--warn-deep); --_glow:var(--warn-glow); }
    .legend .dot.bad  { --_mid:var(--bad-mid);  --_deep:var(--bad-deep);  --_glow:var(--bad-glow); }
    
    /* ключевые кадры «дыхания» — мягкий пульс ореола */
    @keyframes breathe{
      0%,100% { opacity:.35; transform: scale(var(--breathe-min)); }
      50%     { opacity:.85; transform: scale(var(--breathe-max)); }
    }
    
    /* уважаем системную настройку «уменьшить движение» */
    @media (prefers-reduced-motion: reduce){
      .legend .dot::after{ animation:none; opacity:.45; transform:none; }
    }

    /* < 336px: скрываем TF и разделитель перед ним */    
    @media (max-width: 336px){
      .pair .sep-tf,
      .pair .tf{ display:none; }
    }
  </style>
</head>
<body>
  <div class="viewport">
    <!-- верхняя технологическая зона 40px (пустая, для системных панелей; по ТЗ оставляем) -->
    <div class="topbar">
      <div class="left">
        <button class="btn" id="btnTF"><b>TF · 1h</b></button>
        <!-- Кнопка Настройки -->
        <button class="btn btn-icon" id="btnSettings" title="Настройки" aria-label="Настройки">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- SVG, адаптирован под темы: fill="currentColor", лишний пустой path убран -->
            <path fill="currentColor"
              d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- центральная область: чистая (под реальный график) -->
    <div class="center" id="chartRoot"></div>

    <div class="divider"></div>

    <!-- нижняя панель управления -->
    <div class="bottombar">
      <div class="left">
        <span class="led" id="led" data-state="bad" title="Онлайн (WS)"></span>
        <span class="pair" id="pair">OKX · BTC-USDT-SWAP</span>
        <span class="time" id="time">—</span>
        <!-- Кнопка Обновить -->
        <button class="btn btn-icon" id="btnRefresh" title="Обновить" aria-label="Обновить">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- SVG, адаптирован под темы: fill="currentColor", лишний пустой path убран -->
            <path fill="currentColor"
              d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
          </svg>
        </button>        
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="backdrop" id="dlgSettings" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
      <h3>Настройки</h3>

      <div class="row">
        <div class="label">Тема</div>
        <div class="grid-3" id="themeGrid">
          <div class="pill" data-theme="light">Light</div>
          <div class="pill active" data-theme="blue">Blue</div>
          <div class="pill" data-theme="dark">Dark</div>
        </div>
      </div>

      <div class="row">
        <div class="label">Время</div>
        <div class="grid-2">
          <div class="pill" data-timezone="local">Локаль</div>
          <div class="pill active" data-timezone="utc">UTC</div>
        </div>
      </div>

      <div class="row">
        <div class="label">Формат</div>
        <div class="grid-2">
          <div class="pill active" data-tfmt="clock">Только время</div>
          <div class="pill" data-tfmt="rel">Относительное</div>
        </div>
      </div>

      <button class="btn close" id="btnCloseSettings">Закрыть</button>
    </div>
  </div>

  <!-- TF -->
  <div class="backdrop" id="dlgTF" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="TF">
      <h3>Таймфрейм</h3>
      <div class="grid-3" id="tfGrid">
        <div class="pill" data-tf="15m">15m</div>
        <div class="pill" data-tf="1h">1h</div>
        <div class="pill active" data-tf="4h">4h</div>
        <div class="pill" data-tf="8h">8h</div>
        <div class="pill" data-tf="12h">12h</div>
        <div class="pill" data-tf="1d">1d</div>
      </div>
      <button class="btn close" id="btnCloseTF">Закрыть</button>
    </div>
  </div>

  <!-- Legend -->
  <div class="backdrop" id="dlgLegend" aria-hidden="true">
    <div class="modal legend" role="dialog" aria-modal="true" aria-label="Legend">
      <h3>Что значит индикатор состояния?</h3>
      <ul>
        <li><span class="dot ok"></span><b>Онлайн (WS)</b> — данные обновляются в реальном времени.</li>
        <li><span class="dot warn"></span><b>Деградирован (REST)</b> — WebSocket недоступен, данные периодически подгружаются.</li>
        <li><span class="dot bad"></span><b>Оффлайн (DIS)</b> — нет связи с источниками.</li>
      </ul>
      <button class="btn close" id="btnCloseLegend">Понятно</button>
    </div>
  </div>
</body>
</html>
