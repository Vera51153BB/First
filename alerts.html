<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Уведомления</title>
<style>
  :root{
    --bg:#050029;
    --text:#e6ddcd;
    --green:#79c172;
    --red:#ff5f5f;
    --muted:#a7a093;

    --card-r: 20px;                  /* радиус и для блоков, и для кнопки */
    --v-gap: clamp(14px,3.5vw,22px); /* ЕДИНЫЙ вертикальный шаг «воздуха» */

    --pill-h: clamp(40px,9vw,56px);
    --pill-w: clamp(180px,60vw,320px);
    --radius: 999px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    line-height:1.35;
    display:flex; justify-content:center;
  }

  .wrap{
    width:min(680px,92vw);
    padding:clamp(16px,3vw,28px);
    display:flex; flex-direction:column;
  }
  h1{
    margin:0 0 .8rem;font-weight:800;letter-spacing:.02em;
    font-size:clamp(21px,5vw,29px); text-transform:uppercase;
  }
  
  /* Вертикальная колонка: ВСЕ — список — кнопка — подпись */
  .stack{
    display:flex; flex-direction:column;
    gap: var(--v-gap);
    padding-bottom: var(--v-gap); /* воздух до низа страницы */
  }

  /* Карточки */
  .section{
    padding:clamp(12px,2.6vw,18px);
    border:1px solid #2a2458;
    border-radius:var(--card-r);
    background:rgba(255,255,255,.02);
  }

  .title{ font-size:clamp(16px,3.6vw,22px); font-weight:700 }

  /* Шапка секции «все» */
  .controls-header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:clamp(10px,2.5vw,14px);
  }
  .status-badge{
    display:inline-block; padding:.25em .8em; border-radius:999px;
    font-size:clamp(12px,2.8vw,14px); font-weight:700;
    background:#211a53; color:var(--text); border:1px solid #3a3276;
  }

  /* Две большие кнопки «включить/выключить» */
  .actions{ display:flex; gap:clamp(10px,2.6vw,14px) }
  .btn{
    border:none; cursor:pointer; border-radius:999px;
    padding: clamp(10px,2.6vw,14px) clamp(18px,4.4vw,26px);
    font-size:clamp(14px,3.6vw,18px); font-weight:800; letter-spacing:.02em;
    color:#050029; transition:transform .08s ease, filter .2s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
    flex: 1 1 0;        /* одинаковая ширина */
    white-space: nowrap;/* остаются в одну строку на мобилках */
  }
  .btn:active{ transform:translateY(1px) scale(.99) }
  .btn.green{ background:var(--green) }
  .btn.red  { background:var(--red) }

  /* Список уведомлений */
  .item{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:12px 0 }
  .item + .item{ border-top:1px dashed #2a2458 }
  .name{ font-size:clamp(15px,3.2vw,20px) }
  .state{ color:var(--muted); font-size:clamp(12px,2.8vw,14px); margin-top:6px }

  /* Переключатель */
  .switch{
    --pad:6px;
    position:relative; width:var(--pill-w); height:var(--pill-h);
    border-radius:var(--radius); border:1px solid #382f78;
    background:linear-gradient(90deg, var(--green) 0 50%, var(--red) 50% 100%);
    display:inline-flex; align-items:center; justify-content:space-between;
    padding:0 var(--pad); color:#050029; user-select:none; cursor:pointer;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 18px rgba(0,0,0,.25);
  }
  .switch .label{
    font-weight:900; letter-spacing:.03em; text-transform:uppercase;
    font-size:clamp(12px,2.8vw,16px); width:50%;
    display:flex; align-items:center; justify-content:center;
  }
  .switch .knob{
    position:absolute; top:50%; transform:translateY(-50%);
    width: calc(var(--pill-h) - var(--pad)*2); height: calc(var(--pill-h) - var(--pad)*2);
    border-radius:50%; background:#2d2a59;
    box-shadow: 0 6px 12px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    transition:left .18s ease;
    left: var(--pad); /* «вкл» слева */
  }
  .switch[data-on="false"] .knob{ left: calc(100% - var(--pill-h) + var(--pad)) }

  /* Кнопка «Сохранить настройки» (ширина=карточкам, радиус=как у карточек) */
  .save-btn{
    width:100%;
    border-radius: var(--card-r);
    border: 1px solid var(--text);
    background: var(--bg);
    color: var(--text);
    padding: clamp(14px,3.5vw,18px);
    font-weight:800; letter-spacing:.02em;
    font-size: clamp(16px,4vw,22px);
    text-align:center;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
    cursor:pointer;
    transition: transform .08s ease, filter .2s ease;
  }
  .save-btn:active{ transform: translateY(1px) scale(.99) }

  /* Подпись в самом низу */
  .footnote{ color:var(--muted); text-align:center; font-size:clamp(12px,2.8vw,14px) }
  
  /* единая функция уведомлений с тостом вне Telegram */
/* быстрый тост для браузера */
.toast{
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  background: #1b1645;
  color: #e6ddcd;
  border: 1px solid #3a3276;
  border-radius: 12px;
  padding: 12px 16px;
  opacity: 0;
  transition: opacity .2s;
  z-index: 9999;
}
.toast.show{ opacity: 1; }
 
  /* ----- Мобильная раскладка: заголовок слева сверху, тумблер ниже справа ----- */
@media (max-width: 786px) {
  .item{
    grid-template-columns: 1fr;   /* одна колонка */
    align-items: start;
    gap: 6px;                      /* небольшой вертикальный зазор */
  }
  .item .switch{
    justify-self: end;             /* выровнять тумблер по правому краю */
    margin-top: 4px;               /* маленький отступ сверху */
  }
  .item .name{
    margin-bottom: 2px;            /* чуть прижмём подпись кверху */
  }
}
</style>
</head>
<body>
  <main class="wrap">
          <h1>Управление уведомлениями</h1>
    <div class="stack">

      <!-- Секция «все» -->
      <section class="section">
        <div class="controls-header">
          <div class="title">все</div>
          <span id="allState" class="status-badge">частично</span>
        </div>
        <div class="actions">
          <button class="btn green" id="btnAllOn">включить</button>
          <button class="btn red"   id="btnAllOff">выключить</button>
        </div>
      </section>

      <!-- Список тумблеров -->
      <section class="section" id="list"></section>

      <!-- Кнопка сохранения -->
      <button class="save-btn" id="saveBtn">Сохранить настройки</button>

      <!-- Подпись внизу страницы -->
      <div class="footnote">
        Переключатели сохраняются на этом устройстве и применяются мгновенно.
      </div>
    </div>
  </main>

<script>
/* ===== модель ===== */
const STORAGE_KEY = 'okx_alerts_v1';
const DEFAULT_ALERTS = [
  { id: 'balance', name: 'Баланс монет', on: true },
  { id: 'alert2',  name: 'уведомление 2', on: true },
  { id: 'alert3',  name: 'уведомление 3', on: true },
  { id: 'alert4',  name: 'уведомление 4', on: true },
];

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return DEFAULT_ALERTS.slice();
    const arr = JSON.parse(raw);
    const map = Object.fromEntries(arr.map(a=>[a.id, a.on]));
    return DEFAULT_ALERTS.map(d => ({...d, on: map[d.id] ?? d.on}));
  }catch{ return DEFAULT_ALERTS.slice(); }
}
function saveState(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

/* ===== рендер ===== */
const listEl = document.getElementById('list');
const allStateEl = document.getElementById('allState');
let alerts = loadState();

function render(){
  listEl.innerHTML = '';
  alerts.forEach(a=>{
    const row = document.createElement('div'); row.className='item';

    const left = document.createElement('div');
    left.innerHTML = `
      <div class="name">${a.name}</div>
      <div class="state" id="state-${a.id}">${a.on?'включено':'выключено'}</div>
    `;
    row.appendChild(left);

    const sw = document.createElement('button');
    sw.type='button'; sw.className='switch';
    sw.setAttribute('data-on', String(a.on));
    sw.setAttribute('aria-pressed', String(a.on));
    sw.innerHTML = `
      <span class="label">ВКЛ</span>
      <span class="label">ВЫК</span>
      <span class="knob"></span>
    `;
    sw.addEventListener('click', ()=>{
      a.on = !a.on;
      saveState(alerts);
      updateOne(a.id);
      updateAllBadge();
    });
    row.appendChild(sw);

    listEl.appendChild(row);
  });

  updateAllBadge();
}

function updateOne(id){
  const a = alerts.find(x=>x.id===id);
  const state = document.getElementById('state-'+id);
  if(state) state.textContent = a.on ? 'включено' : 'выключено';
  const idx = alerts.findIndex(x=>x.id===id);
  const btn = listEl.querySelectorAll('.switch')[idx];
  if(btn){
    btn.setAttribute('data-on', String(a.on));
    btn.setAttribute('aria-pressed', String(a.on));
  }
}

function updateAllBadge(){
  const onCount = alerts.filter(a=>a.on).length;
  let txt = 'частично';
  if(onCount===0) txt='выключено';
  else if(onCount===alerts.length) txt='включено';
  allStateEl.textContent = txt;
}

/* Кнопки «все» */
document.getElementById('btnAllOn').addEventListener('click', ()=>{
  alerts.forEach(a=>a.on=true); saveState(alerts); render();
});
document.getElementById('btnAllOff').addEventListener('click', ()=>{
  alerts.forEach(a=>a.on=false); saveState(alerts); render();
});

/* ===== Telegram Web App ===== */
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  function showToast(msg){
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    document.body.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); el.remove(); }, 2200);
  }

  // ✅ Показываем системный поп-ап Telegram, где возможно
  function notifySaved(closeAfter = false){
    const title = 'OKXcandlebot';
    const msg   = 'Настройки сохранены на этом устройстве.';

    if (tg && typeof tg.showPopup === 'function') {
      tg.showPopup(
        { title, message: msg, buttons: [{ type: 'ok' }] },
        () => { if (closeAfter) { try { tg.close(); } catch {} } }
      );
      tg.HapticFeedback?.notificationOccurred('success');
      return;
    }

    if (tg && typeof tg.showAlert === 'function') {
      tg.showAlert(`${title}\n${msg}`, () => {
        if (closeAfter) { try { tg.close(); } catch {} }
      });
      tg.HapticFeedback?.notificationOccurred('success');
      return;
    }

    // Фолбэк для обычного браузера
    showToast(`${title}\n${msg}`);
  }

  // обработчик «Сохранить настройки»
  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const payload = JSON.stringify({ alerts });

    if (tg && typeof tg.sendData === 'function') {
      tg.sendData(payload);
      // показываем системный поп-ап и закрываем мини-приложение после OK
      notifySaved(true);
    } else {
      // открыто не в Telegram — просто локально сохраним и покажем тост
      localStorage.setItem('okx_alerts_v1', JSON.stringify(alerts));
      notifySaved(false);
    }
  });

/* init */
render();
</script>
</body>
</html>
