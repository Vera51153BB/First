<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OKX Chart (Mini App)</title>
  <style>
    :root{ --bg:#0b0f14; --text:#e6e6e6 }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
    #wrap{height:100%;display:flex;flex-direction:column}
    header{padding:10px 14px;font-weight:600}
    #chart{flex:1;min-height:320px}
    #err{padding:10px 14px;color:#ffb4b4}
  </style>
  <!-- Lightweight-Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<div id="wrap">
  <header id="title">Загрузка…</header>
  <div id="chart"></div>
  <div id="err"></div>
</div>

<script type="module">
/**
 * Минимальный, «безболезненный» для Telegram WebApp рендер графика:
 * - Берём ?instId=BTC-USDT-SWAP и ?tf=1H|15m|1D (по умолчанию 1H)
 * - Тянем историю с OKX REST и строим свечи
 * - Без редиректов, без попапов — работает внутри WebView
 */

const qs      = new URLSearchParams(location.search);
const instId  = (qs.get('instId') || 'BTC-USDT-SWAP').toUpperCase();
const tf      = (qs.get('tf')     || '1H');          // OKX форматы: 1m,3m,5m,15m,30m,1H,2H,4H,1D…
const limit   = 500;                                  // сколько свечей брать

document.getElementById('title').textContent = `${instId} • OKX (${tf})`;

const chart = LightweightCharts.createChart(document.getElementById('chart'), {
  layout: { background: { color:'#0b0f14' }, textColor:'#e6e6e6' },
  grid:   { vertLines:{ color:'#1c232b' }, horzLines:{ color:'#1c232b' } },
  rightPriceScale: { borderColor:'#2a3542' },
  timeScale: { borderColor:'#2a3542', timeVisible: true, secondsVisible: false },
});
const series = chart.addCandlestickSeries({
  upColor:'#26a69a', downColor:'#ef5350', borderVisible:false,
  wickUpColor:'#26a69a', wickDownColor:'#ef5350'
});

const errBox = document.getElementById('err');

async function loadCandles(){
  try{
    const url = `https://www.okx.com/api/v5/market/candles?instId=${encodeURIComponent(instId)}&bar=${encodeURIComponent(tf)}&limit=${limit}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    const rows = Array.isArray(j.data) ? j.data : [];
    // Ответ OKX идёт от новой свечи к старой — разворачиваем.
    const data = rows.slice().reverse().map(row => ({
      time:  Math.floor(Number(row[0]) / 1000), // ts в секундах
      open:  Number(row[1]),
      high:  Number(row[2]),
      low:   Number(row[3]),
      close: Number(row[4]),
    }));
    if (!data.length) throw new Error('Пустой ответ API');
    series.setData(data);
    chart.timeScale().fitContent();
    errBox.textContent = '';
  }catch(e){
    errBox.textContent = `Ошибка загрузки свечей: ${e.message}`;
  }
}

await loadCandles();

/* (опционально) Хотите ещё и лайв-обновления — раскомментируйте блок ниже.
   В Mini App OKX WS обычно работает стабильно. Канал: "candle{bar}". */
 const chan = `candle${tf}`; // напр. 1H -> candle1H, 15m -> candle15m
 const ws = new WebSocket('wss://ws.okx.com/ws/v5/public');
 ws.onopen = () => ws.send(JSON.stringify({op:'subscribe', args:[{channel:chan, instId}]}));
 ws.onmessage = ev => {
   try{
     const m = JSON.parse(ev.data);
     if (!m.data) return;
     for (const row of m.data){
       series.update({
         time:  Math.floor(Number(row[0]) / 1000),
         open:  Number(row[1]), high:Number(row[2]), low:Number(row[3]), close:Number(row[4]),
       });
     }
   }catch(_){}
 };
</script>
</body>
</html>
