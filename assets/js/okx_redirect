/* Устойчивый редирект на страницу инструмента OKX
   Параметры:
     ?inst=BTC-USDT-SWAP   — полное имя инструмента OKX (приоритет)
     ?base=BTC             — только базовый тикер; соберём BASE-USDT-SWAP

   Поведение:
     1) если в окружении есть Telegram.WebApp — пробуем WebApp.openLink(...)
     2) window.open(url, '_blank')  (для in-app браузеров)
     3) location.replace(url)
     4) показываем кнопку-переход как fallback
*/

(function () {
  const $ = (id) => document.getElementById(id);
  const p = new URLSearchParams(location.search);

  // --- читаем вход ---
  const clean = (s) => String(s || "").toUpperCase().replace(/[^A-Z0-9\-]/g, "").slice(0, 64);

  let inst = clean(p.get("inst"));
  let base = clean(p.get("base"));

  // если дали только base — собираем стандартный своп на USDT
  if (!inst) {
    inst = base ? `${base}-USDT-SWAP` : "BTC-USDT-SWAP";
  }

  // нормализуем частые форматы (BTCUSDT, BTC-USDT без -SWAP)
  if (!inst.includes("-")) {
    const m = inst.match(/^([A-Z0-9]{3,10})(USDT|USD|USDC)$/);
    if (m) inst = `${m[1]}-${m[2]}-SWAP`;
  } else if (!/-SWAP$/i.test(inst)) {
    const parts = inst.split("-");
    if (parts.length >= 2) inst = `${parts[0]}-${parts[1]}-SWAP`;
  }

  // итоговый URL OKX (перпетуалы)
  const target = `https://www.okx.com/trade-swap/${encodeURIComponent(inst)}`;

  // fallback-кнопка, если автоматический редирект запретили
  function showFallback() {
    const fb = $("fallback");
    if (fb) {
      fb.innerHTML =
        `<a class="btn" href="${target}" rel="noopener" target="_blank">Открыть ${inst} на OKX</a><div class="muted">Если не открывается в мини-браузере, нажмите кнопку.</div>`;
    }
  }

  // 1) Telegram API
  try {
    const wa = window.Telegram && window.Telegram.WebApp;
    if (wa && typeof wa.openLink === "function") {
      // открывает внешний URL корректно в телеграм-контейнере
      wa.openLink(target, { try_instant_view: false });
      return;
    }
  } catch (_) {}

  // 2) классическое окно/вкладка
  try {
    const w = window.open(target, "_blank");
    if (w) return;
  } catch (_) {}

  // 3) смена локации (лучше replace, чтобы "Назад" вернул в бота)
  try {
    location.replace(target);
    return;
  } catch (_) {}

  // 4) запасной вариант — вручную
  showFallback();
})();
